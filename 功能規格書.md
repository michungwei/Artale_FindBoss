# 自動遊戲監控與通知系統 - 功能規格書

## 1. 專案概述

### 1.1 主要功能
**Artale找Boss神器** - 一個專為Artale遊戲設計的自動BOSS檢測與頻道切換工具。使用影像識別技術監控遊戲畫面，當檢測到BOSS訊息時透過 Telegram Bot 發送通知並暫停等待玩家處理，無BOSS時自動執行頻道切換操作。

### 1.2 技術規格
- **開發語言**: Python 3.8+
- **GUI框架**: tkinter (內建，穩定可靠)
- **影像處理**: OpenCV + PIL + mss
- **螢幕截圖**: pyautogui (主要) + mss (備用)
- **滑鼠控制**: pyautogui + pynput
- **通知服務**: Telegram Bot API
- **視窗特性**: 永遠置頂顯示

### 1.3 Telegram Bot 設定
- **Bot Token**: `8232088184:AAG2piqVAVbiBdKENJ8tsUlm8I4Zz2OmTV4`
- **API 文件**: https://core.telegram.org/bots/api
- **通知訊息**: "**BOSS出現！**" + 時間戳記

## 2. 系統流程設計

### 2.1 遊戲階段識別與處理

系統需要識別並處理以下 5 個階段（已移除階段B）：

#### 階段 A: 頻道切換成功確認
- **用途**: 確認頻道切換是否成功完成
- **檢測方式**: 比對當前畫面與階段A設定截圖的相似度
- **動作**: 
  - **匹配**: 進入階段C (登入流程)
  - **不匹配**: 繼續等待檢查
  - **未設定**: 跳過檢查直接進入階段C
- **狀態顯示**: 
  - `階段A: 檢查是否為頻道切換成功畫面`
  - `階段A: ✓ 匹配頻道切換成功畫面`
  - `階段A: ✗ 不匹配頻道切換成功畫面，繼續檢查`

#### 階段 C: 登入畫面
- **用途**: 自動執行登入操作
- **檢測方式**: 比對當前畫面與階段C設定截圖的相似度
- **動作**: 
  - **匹配**: 點擊登入按鈕，進入階段D
  - **不匹配**: 等待登入畫面出現
  - **未設定**: 直接執行登入點擊
- **安全機制**: 只有確認是登入畫面才執行點擊
- **狀態顯示**: 
  - `階段C: ✓ 匹配登入畫面，執行登入點擊`
  - `階段C: ✗ 不匹配登入畫面，繼續等待`

#### 階段 D: 角色選擇畫面
- **用途**: 自動執行角色選擇操作
- **檢測方式**: 比對當前畫面與階段D設定截圖的相似度
- **動作**: 
  - **匹配**: 點擊角色選擇按鈕，進入階段E
  - **不匹配**: 等待角色選擇畫面出現
  - **未設定**: 直接執行角色點擊
- **安全機制**: 只有確認是角色選擇畫面才執行點擊

#### 階段 E: BOSS檢測 (核心功能)
- **用途**: 檢測BOSS訊息並處理
- **檢測方式**: 
  - 在王怪檢測區域內檢測BOSS訊息顏色
  - 使用顏色容差和像素閾值雙重判斷
- **動作**:
  - **檢測到BOSS**: 發送Telegram通知，系統暫停等待玩家處理
  - **無BOSS**: 等待設定的秒數後進入階段F
- **倒數計時**: 顯示距離頻道切換的剩餘時間
- **無BOSS切換延遲**: 可設定30秒等待時間 (可調整)

#### 階段 F: 智能頻道切換
- **用途**: 執行頻道切換操作
- **檢測方式**: 比對當前畫面與階段F設定截圖的相似度
- **動作邏輯**:
  - **未達目標畫面**: 重複執行點位1和2的點擊
  - **達到目標畫面**: 執行點位3和4的點擊，完成切換
- **智能重試**: 直到檢測到目標畫面才執行最後步驟
- **下一階段**: 回到階段A進行頻道切換確認

## 3. 用戶介面設計

### 3.1 區域選擇功能

#### 主要檢測區域: 王怪檢測區域
- **用途**: BOSS訊息檢測 (所有階段統一使用此區域)
- **選擇方式**: 滑鼠拖曳選擇，支援視覺化選擇界面
- **檢測方法**: 
  - BOSS檢測: 計算BOSS訊息顏色的像素數量
  - 階段匹配: 比對當前畫面與設定截圖的相似度
- **視覺化選擇**: 
  - 全螢幕半透明覆蓋層
  - 紅色半透明選擇框
  - 即時座標顯示
  - ESC取消選擇

#### 已移除: 頻道檢測區域
- **原因**: 統一使用王怪檢測區域，簡化設定流程
- **替代方案**: 階段F使用王怪檢測區域進行畫面匹配

### 3.2 BOSS訊息判斷設定 (核心功能)

#### 顏色設定功能
- **選擇顏色按鈕**: 使用系統標準色彩選擇器
- **滴管取色按鈕**: 直接從畫面取得顏色
  - 點擊後進入取色模式，滑鼠點擊任意位置取色
  - 自動更新顏色設定和顯示
- **即時顏色預覽**: 雙色塊設計
  - 左方塊: 顯示當前設定的BOSS顏色
  - 右方塊: 即時顯示滑鼠位置的顏色 (300ms更新)

#### 檢測參數設定
- **像素閾值**: 符合顏色條件的像素數量門檻
- **顏色容差**: 顏色相似度寬容程度 (0-255)
  - 0: 必須完全一樣
  - 50: 中等寬鬆 (預設)
  - 100+: 較寬鬆，適合有陰影的文字
- **無BOSS切換延遲**: 無BOSS時多久後切換頻道 (秒)

#### 測試功能
- **測試BOSS檢測按鈕**: 10秒內檢測BOSS訊息
- **詳細結果報告**: 顯示檢測結果和當前設定參數
- **智能建議**: 未檢測到時提供調整建議

### 3.3 點位設定 (直觀操作)

#### 設定方式改進
- **移除F1熱鍵**: 改為更直觀的點擊操作
- **專屬設定按鈕**: 每個點位都有獨立的「設定」按鈕
- **滑鼠直接點擊**: 點擊設定按鈕後，滑鼠點擊目標位置即可記錄
- **狀態顯示**: 綠色座標顯示已設定，紅色「未設定」顯示未設定

#### 點位配置
- **登入按鈕**: 階段C使用，點擊登入
- **角色選擇**: 階段D使用，點擊角色
- **頻道切換1-2**: 階段F前期重複執行，直到看到目標畫面
- **頻道切換3-4**: 階段F後期執行，完成頻道切換

#### 點位設定流程
1. 點擊對應的「設定」按鈕
2. 按鈕變為高亮「點擊目標」狀態
3. 移動滑鼠到目標位置
4. 點擊滑鼠左鍵記錄位置
5. 自動完成設定並顯示座標

### 3.4 時間設定
- **王怪檢測時間**: 設定階段 E 的最大檢測時間
- **點擊間隔**: 設定點擊動作的間隔時間
- **畫面變化等待時間**: 設定等待畫面變化的超時時間

### 3.5 系統控制功能

#### 主要控制按鈕
- **開始/停止按鈕**: 
  - 初始狀態顯示「開始」
  - 點擊開始後切換為「停止」
  - 停止後完全終止系統運行，回到待機狀態
  - 停止後按鈕重新顯示為「開始」

#### 暫停/繼續按鈕（智能切換）
- **動態功能**: 同一個按鈕根據系統狀態顯示不同功能
- **暫停模式**: 
  - 系統運行時顯示「暫停」
  - 可隨時暫停當前工作流程
  - 暫停後保持當前階段狀態
- **繼續模式**: 
  - 系統暫停時顯示「繼續」
  - 點擊後從暫停的階段繼續執行
- **王怪檢測後**: 
  - 檢測到王怪後自動切換為「繼續」模式
  - 使用者打完王後點擊繼續執行階段 F
- **按鈕樣式**: 
  - 暫停狀態：一般樣式
  - 王怪檢測後：突出樣式（如紅色或閃爍）
  - 手動暫停後：黃色或橙色提示樣式

### 3.6 階段設定功能 (取代錄製功能)

#### 設計理念
- **移除複雜錄製**: 取代原本的自動錄製功能
- **獨立階段設定**: 每個階段可單獨設定參考截圖
- **即時截圖確認**: 點擊設定時立即截圖並確認

#### 階段設定流程
- **點擊設定按鈕**: 每個階段都有專屬「設定」按鈕
- **自動截圖**: 截取當前王怪檢測區域的畫面
- **確認對話框**: 顯示截圖並詢問是否代表該階段
- **縮圖顯示**: 設定完成後按鈕變為縮圖預覽
- **右鍵預覽**: 右鍵點擊縮圖可放大查看和重新設定

#### 階段截圖用途
- **階段A**: 頻道切換成功的參考畫面
- **階段C**: 登入畫面的參考截圖
- **階段D**: 角色選擇畫面的參考截圖
- **階段E**: 遊戲內畫面 (可選)
- **階段F**: 頻道切換目標畫面

#### 持久化保存
- **PNG檔案**: 截圖保存為 `stage_screenshots/stage_X.png`
- **自動載入**: 程式重啟時自動載入已保存的截圖
- **縮圖顯示**: 載入後自動創建縮圖按鈕

### 3.7 可收合UI設計

#### 模組化界面
- **7個可收合區塊**: 每個功能區塊都可獨立收合/展開
- **智能預設狀態**: 常用功能展開，進階功能預設收合
- **狀態記憶**: 收合狀態自動保存，重啟後保持

#### 收合區塊列表
1. **系統狀態** - 顯示當前運行狀態 (展開)
2. **系統控制** - 開始/停止、暫停/繼續按鈕 (展開)
3. **Telegram設定** - 聊天室ID和測試通知 (展開)
4. **區域設定** - 王怪檢測區域設定 (展開)
5. **階段設定** - 5個階段的截圖設定 (預設收合)
6. **BOSS訊息判斷設定** - 顏色、容差、測試功能 (預設收合)
7. **點位設定** - 6個點擊位置設定 (預設收合)

### 3.8 設定管理與持久化
- **完整設定保存**: 所有參數、截圖、收合狀態自動保存
- **自動載入**: 程式啟動時自動載入所有已保存設定
- **重新設定**: 清除所有設定檔案和截圖，回到初始狀態
- **設定驗證**: 檢查設定完整性，提供智能建議

## 4. Telegram 通知功能

### 4.1 通知觸發條件
- 在階段 E 檢測到王怪出現時發送通知

### 4.2 通知內容
- **基本訊息**: "BOSS出現！"
- **時間戳記**: 檢測到的時間
- **截圖**: 可選擇是否附加當前畫面截圖

### 4.3 聊天室設定
- **目標聊天室**: 用戶需要設定要發送通知的 Telegram 聊天室 ID
- **測試功能**: 提供測試按鈕確認通知功能正常

### 4.4 如何取得 Telegram 聊天室 ID

#### 方法一：透過 Bot 取得個人聊天 ID
1. 在 Telegram 中搜尋並開始與您的 Bot 對話
2. 發送任意訊息給 Bot（例如：`/start` 或 `hello`）
3. 在瀏覽器中訪問以下網址（替換 YOUR_BOT_TOKEN）：
   ```
   https://api.telegram.org/botYOUR_BOT_TOKEN/getUpdates
   ```
4. 在返回的 JSON 資料中找到 `"chat":{"id":數字}` 
5. 這個數字就是您的聊天室 ID（個人聊天通常是正數）

#### 方法二：透過 @userinfobot 取得個人 ID
1. 在 Telegram 中搜尋 `@userinfobot`
2. 開始對話並發送 `/start`
3. Bot 會直接回覆您的用戶 ID

#### 方法三：取得群組聊天室 ID
1. 將您的 Bot 加入目標群組
2. 在群組中發送任意訊息
3. 使用方法一的 API 網址查看 getUpdates
4. 群組 ID 通常是負數（例如：-1001234567890）

#### 方法四：透過 @RawDataBot 取得群組 ID
1. 將 `@RawDataBot` 加入您的群組
2. 在群組中發送任意訊息
3. Bot 會回覆包含群組 ID 的詳細資訊

#### 實際範例
假設您的 Bot Token 是：`8232088184:AAG2piqVAVbiBdKENJ8tsUlm8I4Zz2OmTV4`

訪問：
```
https://api.telegram.org/bot8232088184:AAG2piqVAVbiBdKENJ8tsUlm8I4Zz2OmTV4/getUpdates
```

返回的 JSON 範例：
```json
{
  "ok": true,
  "result": [
    {
      "update_id": 123456789,
      "message": {
        "message_id": 1,
        "from": {...},
        "chat": {
          "id": 987654321,
          "first_name": "Your Name",
          "type": "private"
        },
        "text": "hello"
      }
    }
  ]
}
```

在這個例子中，聊天室 ID 就是：`987654321`

## 5. 技術實作細節

### 5.1 影像識別
- **螢幕截圖**: 即時擷取指定區域畫面
- **顏色檢測**: 計算指定顏色在區域內的像素數量
- **畫面變化檢測**: 比較前後畫面差異判斷是否有變化

### 5.2 自動化控制
- **滑鼠點擊**: pyautogui 執行精確座標點擊
- **滑鼠監聽**: pynput 全域監聽用於點位設定
- **多執行緒**: 監控循環與 GUI 分離，確保界面響應
- **階段管理**: 智能狀態機控制階段轉換

### 5.3 影像識別與比對
- **螢幕截圖**: mss 高效截取，pyautogui 作備用
- **顏色檢測**: OpenCV 計算顏色匹配像素數量
- **階段匹配**: 使用 SSIM 或像素差異比對截圖相似度
- **即時預覽**: 300ms 更新滑鼠位置顏色
- **容差機制**: 可調整顏色相似度寬容程度

### 5.4 Telegram 整合
- **Bot API**: 使用 requests 庫呼叫 Telegram API
- **訊息格式**: "BOSS出現！" + 時間戳記
- **錯誤重試**: 網路失敗時的重試機制
- **測試功能**: 驗證聊天室 ID 和 Bot Token

### 5.5 錯誤處理
- **網路錯誤**: Telegram API 呼叫失敗的重試機制
- **畫面識別失敗**: 提供手動介入或重新開始選項
- **系統異常**: 記錄錯誤日誌並提供除錯資訊

## 6. 程式安裝與執行

### 6.1 系統需求
- **作業系統**: Windows 10/11
- **Python 版本**: Python 3.8 或以上
- **必要套件**: 見 requirements.txt

### 6.2 安裝步驟

#### 方法一：使用 Python 直接執行（推薦）
```bash
# 1. 安裝依賴套件
py -m pip install -r requirements.txt

# 2. 執行程式
py game_monitor.py
```

#### 方法二：使用 Python 虛擬環境（進階）
```bash
# 1. 建立虛擬環境
py -m venv venv

# 2. 啟動虛擬環境
venv\Scripts\activate

# 3. 安裝依賴套件
pip install -r requirements.txt

# 4. 執行程式
python game_monitor.py

# 5. 結束後關閉虛擬環境
deactivate
```

#### 方法三：批次檔啟動（推薦）
提供三種批次檔啟動方式：

**1. run.bat - 標準啟動（推薦新手）**
- 雙擊執行，顯示安裝進度
- 程式啟動後可關閉命令提示字元視窗
- 首次執行自動安裝套件

**2. run_silent.bat - 靜默啟動**
- 完全無視窗啟動
- 適合熟悉的使用者
- 程式在背景運行

**3. run_with_check.vbs - 智能啟動**
- 檢查程式是否已在運行
- 防止重複啟動
- 啟動狀態提示對話框

選擇任一方式雙擊即可執行

### 6.3 套件說明
程式依賴的主要套件：
- **pillow**: 圖像處理
- **pyautogui**: 螢幕截圖和滑鼠控制
- **requests**: HTTP 請求 (Telegram API)
- **opencv-python**: 影像識別和比較
- **keyboard**: 熱鍵監聽 (F1)
- **mss**: 高效能螢幕截圖
- **pynput**: 滑鼠點擊監聽（錄製功能）

## 7. 用戶操作流程

### 7.1 初始設定流程
1. 啟動程式
2. 設定 Telegram 聊天室 ID
3. 選擇王怪檢測區域（區域 1）
4. 選擇頻道切換檢測區域（區域 2）
5. 設定檢測顏色和閾值
6. 設定各階段點擊位置（使用 F1 熱鍵）
7. 設定時間參數
8. 測試 Telegram 通知功能
9. 開始監控

### 7.2 快速設定流程（推薦新手使用）

#### 基本設定階段
1. **啟動程式** - 視窗永遠置頂，方便操作
2. **設定王怪檢測區域** - 拖曳選擇BOSS訊息出現的區域
3. **設定BOSS顏色** - 使用滴管取色或色彩選擇器
4. **調整檢測參數** - 顏色容差、像素閾值、切換延遲

#### 階段截圖設定 (可選但推薦)
1. **階段A設定** - 頻道切換成功後的畫面
2. **階段C設定** - 登入畫面截圖
3. **階段D設定** - 角色選擇畫面截圖
4. **階段F設定** - 頻道切換目標畫面

#### 點位設定
1. **登入按鈕** - 點擊「設定」後點擊登入按鈕位置
2. **角色選擇** - 點擊「設定」後點擊角色按鈕位置
3. **頻道切換1-4** - 依序設定4個頻道切換點位

#### 測試與驗證
1. **測試BOSS檢測** - 確認能正確檢測BOSS訊息
2. **測試Telegram通知** - 確認通知功能正常
3. **開始監控** - 直接進入BOSS檢測循環

### 7.3 手動設定流程（進階使用者）
1. 啟動程式（自動載入已保存設定）
2. 設定 Telegram 聊天室 ID
3. 選擇王怪檢測區域（拖曳選擇）
4. 選擇頻道切換檢測區域（拖曳選擇）
5. 設定檢測顏色和閾值
6. 設定各階段點擊位置（使用 F1 熱鍵）
7. 設定時間參數
8. 測試 Telegram 通知功能
9. 開始監控

### 7.3 日常使用流程（核心功能）
1. **啟動程式** - 視窗永遠置頂，自動載入已保存設定
2. **確認設定正確** - 檢查各項設定是否完整
3. **點擊「開始」** - 直接進入BOSS檢測循環（從階段A開始）
4. **智能階段流程**:
   - **階段A**: 確認頻道切換成功 → 進入階段C
   - **階段C**: 匹配登入畫面 → 自動點擊登入 → 進入階段D
   - **階段D**: 匹配角色選擇 → 自動點擊角色 → 進入階段E
   - **階段E**: BOSS檢測循環，倒數計時顯示
   - **階段F**: 智能頻道切換 → 回到階段A
5. **BOSS處理流程**:
   - 檢測到BOSS → 發送Telegram通知 → 系統暫停
   - 前往遊戲打BOSS
   - 打完後點擊「繼續」按鈕 → 自動進入階段F
6. **系統控制**:
   - **隨時暫停/繼續**: 智能按鈕切換
   - **完全停止**: 回到待機狀態

## 8. 疑難排解

### 8.1 常見問題
- **程式無法啟動**: 檢查 Python 是否正確安裝，使用 `py --version` 確認
- **套件安裝失敗**: 確保網路連線正常，或使用 `py -m pip install --upgrade pip` 更新 pip
- **熱鍵無法使用**: 請以系統管理員身分執行程式
- **Telegram 通知失敗**: 檢查聊天室 ID 和網路連線

### 8.2 效能最佳化
- **關閉不必要的背景程式**: 減少 CPU 和記憶體使用
- **降低螢幕解析度**: 可提升影像處理速度
- **調整檢測間隔**: 根據系統效能調整偵測頻率

## 9. 實作完成狀態

### 9.1 已完成功能 ✅
- **GUI框架**: tkinter (穩定可靠，內建)
- **影像處理**: OpenCV + PIL + mss 整合
- **多執行緒**: 監控循環與GUI完全分離
- **視窗置頂**: 永遠在最上層顯示
- **可收合UI**: 7個模組化區塊
- **階段設定**: 取代錄製功能，更直觀
- **滴管取色**: 即時顏色預覽，直接點擊取色
- **點位設定**: 移除F1熱鍵，直接滑鼠點擊設定
- **智能階段邏輯**: 畫面匹配才執行動作，詳細狀態顯示
- **BOSS檢測**: 顏色容差、像素閾值、測試功能
- **Telegram整合**: 完整通知功能和聊天室ID教學

### 9.2 核心優勢
- **安全可靠**: 階段匹配確認才執行點擊，避免誤觸
- **使用者友好**: 視覺化區域選擇、即時顏色預覽、縮圖顯示
- **設定保存**: 所有參數、截圖、UI狀態完整保存
- **智能控制**: 倒數計時、狀態顯示、錯誤處理
- **模組化設計**: 每個功能獨立，便於維護和擴展

### 9.3 技術特色
- **雙重檢測**: 顏色檢測 + 階段截圖匹配
- **智能重試**: 頻道切換失敗自動重試
- **容差設定**: 適應不同遊戲顯示效果
- **即時反饋**: 300ms顏色更新，詳細狀態顯示
- **錯誤恢復**: 異常時提供明確指引

---

請確認以上規格是否符合您的需求，有任何需要修改或補充的地方請告知。