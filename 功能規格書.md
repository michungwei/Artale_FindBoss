# 自動遊戲監控與通知系統 - 功能規格書

## 1. 專案概述

### 1.1 主要功能
製作一個視窗程式，使用影像識別技術監控畫面特定區域，當檢測到特定條件時透過 Telegram Bot 發送通知，否則執行預設的滑鼠點擊動作。

### 1.2 技術規格
- **開發語言**: Python
- **GUI框架**: 待確認 (建議 tkinter/PyQt)
- **影像處理**: OpenCV 或 PIL
- **螢幕截圖**: pyautogui 或 mss
- **滑鼠控制**: pyautogui
- **通知服務**: Telegram Bot API

### 1.3 Telegram Bot 設定
- **Bot Token**: `8232088184:AAG2piqVAVbiBdKENJ8tsUlm8I4Zz2OmTV4`
- **API 文件**: https://core.telegram.org/bots/api

## 2. 系統流程設計

### 2.1 遊戲階段識別與處理

系統需要識別並處理以下 6 個階段：

#### 階段 A: 登入畫面載入中
- **狀態**: 等待進入黑畫面 loading
- **動作**: 監控畫面變化
- **下一階段**: 階段 B

#### 階段 B: 黑畫面 Loading
- **狀態**: 等待進入登入畫面
- **動作**: 監控畫面變化
- **下一階段**: 階段 C

#### 階段 C: 登入畫面
- **狀態**: 等待點擊登入按鈕
- **動作**: 點擊用戶設定的登入按鈕位置
- **重試機制**: 如果畫面沒改變就繼續點擊
- **下一階段**: 階段 D

#### 階段 D: 選擇角色畫面
- **狀態**: 等待點擊選擇角色按鈕
- **動作**: 點擊用戶設定的角色選擇位置
- **重試機制**: 如果畫面沒改變就繼續點擊
- **下一階段**: 階段 E

#### 階段 E: 遊戲內王怪檢測
- **狀態**: 檢測是否有王怪出現
- **檢測方式**: 
  - 在用戶指定的區域內檢測特定顏色
  - 如果特定顏色像素數量超過閾值，判定為有王
- **動作**:
  - **有王**: 透過 Telegram Bot 發送通知，系統自動暫停，暫停/繼續按鈕切換為「繼續」模式
  - **沒王**: 進入階段 F
- **超時設定**: 用戶可設定檢測時間上限，超時後自動進入階段 F
- **暫停機制**: 
  - **檢測到王怪後自動暫停**: 暫停/繼續按鈕變為突出樣式的「繼續」
  - **使用者手動暫停**: 隨時可點擊暫停/繼續按鈕暫停當前檢測，按鈕變為一般樣式的「繼續」
  - **繼續執行**: 點擊「繼續」後進入階段 F 或從暫停處繼續檢測

#### 階段 F: 切換頻道
- **狀態**: 執行頻道切換流程
- **動作**: 依序點擊用戶設定的 4 個點位
- **點擊邏輯**: 每個點位點擊後需等待畫面變化才能點擊下一個
- **檢測方式**: 使用第二個指定區域檢測是否成功切換頻道
- **下一階段**: 回到階段 E 或其他指定階段

## 3. 用戶介面設計

### 3.1 區域選擇功能
用戶需要指定 2 個矩形區域：

#### 區域 1: 王怪檢測區域
- **用途**: 檢測是否有王怪出現
- **選擇方式**: 滑鼠拖曳選擇 (左上到右下)
- **檢測方法**: 計算指定顏色的像素數量

#### 區域 2: 頻道切換檢測區域
- **用途**: 檢測階段 F 是否成功切換頻道
- **選擇方式**: 滑鼠拖曳選擇 (左上到右下)
- **檢測方法**: 監控區域變化

### 3.2 顏色設定功能
- **目標顏色選擇**: 用戶可指定要檢測的特定顏色
- **顏色選擇器**: 提供色彩選擇工具或 RGB 值輸入
- **閾值設定**: 設定像素數量閾值來判斷是否有王

### 3.3 點擊位置設定

使用 F1 熱鍵記錄滑鼠位置的方式設定以下點位：

#### 階段 C 點位設定
- **數量**: 1 個點位
- **用途**: 登入按鈕位置
- **記錄方式**: 按 F1 記錄當前滑鼠位置

#### 階段 D 點位設定
- **數量**: 1 個點位
- **用途**: 角色選擇按鈕位置
- **記錄方式**: 按 F1 記錄當前滑鼠位置

#### 階段 F 點位設定
- **數量**: 4 個點位
- **用途**: 頻道切換流程的點擊順序
- **記錄方式**: 依序按 F1 記錄 4 個點位
- **點擊邏輯**: 必須等待畫面變化後才能點擊下一個點位

### 3.4 時間設定
- **王怪檢測時間**: 設定階段 E 的最大檢測時間
- **點擊間隔**: 設定點擊動作的間隔時間
- **畫面變化等待時間**: 設定等待畫面變化的超時時間

### 3.5 系統控制功能

#### 主要控制按鈕
- **開始/停止按鈕**: 
  - 初始狀態顯示「開始」
  - 點擊開始後切換為「停止」
  - 停止後完全終止系統運行，回到待機狀態
  - 停止後按鈕重新顯示為「開始」

#### 暫停/繼續按鈕（智能切換）
- **動態功能**: 同一個按鈕根據系統狀態顯示不同功能
- **暫停模式**: 
  - 系統運行時顯示「暫停」
  - 可隨時暫停當前工作流程
  - 暫停後保持當前階段狀態
- **繼續模式**: 
  - 系統暫停時顯示「繼續」
  - 點擊後從暫停的階段繼續執行
- **王怪檢測後**: 
  - 檢測到王怪後自動切換為「繼續」模式
  - 使用者打完王後點擊繼續執行階段 F
- **按鈕樣式**: 
  - 暫停狀態：一般樣式
  - 王怪檢測後：突出樣式（如紅色或閃爍）
  - 手動暫停後：黃色或橙色提示樣式

### 3.6 智能錄製功能

#### 錄製按鈕
- **開始錄製**: 進入智能學習模式，自動記錄使用者操作
- **停止錄製**: 結束錄製並自動分析設定所有參數
- **錄製狀態**: 顯示當前錄製階段和進度

#### 錄製流程設計
- **設定檢查**: 開始前自動檢查是否已設定檢測區域，未設定時引導使用者設定
- **階段識別**: 根據當前階段自動選擇正確的檢測區域
  - 階段 A-E: 使用王怪檢測區域
  - 階段 F: 使用頻道檢測區域
- **畫面變化偵測**: 即時分析指定區域的畫面變化
- **智能確認**: 偵測到變化時彈出截圖確認對話框
- **點擊記錄**: 全域監聽並記錄使用者的滑鼠點擊位置和時間

#### 自動分析與設定
- **點擊分類**: 根據階段自動分類記錄的點擊
  - 階段 C: 第一次點擊設為登入按鈕
  - 階段 D: 第一次點擊設為角色選擇
  - 階段 F: 所有點擊設為頻道切換順序
- **參數配置**: 自動設定所有點擊位置參數
- **設定保存**: 錄製完成後自動儲存所有設定
- **結果報告**: 顯示錄製統計和設定結果

### 3.7 設定管理
- **設定保存**: 所有設定自動保存，下次啟動時載入
- **重新設定**: 提供重新設定按鈕，清除所有已保存的設定
- **設定驗證**: 檢查設定完整性，提示缺少的設定項目

## 4. Telegram 通知功能

### 4.1 通知觸發條件
- 在階段 E 檢測到王怪出現時發送通知

### 4.2 通知內容
- **基本訊息**: "BOSS出現！"
- **時間戳記**: 檢測到的時間
- **截圖**: 可選擇是否附加當前畫面截圖

### 4.3 聊天室設定
- **目標聊天室**: 用戶需要設定要發送通知的 Telegram 聊天室 ID
- **測試功能**: 提供測試按鈕確認通知功能正常

### 4.4 如何取得 Telegram 聊天室 ID

#### 方法一：透過 Bot 取得個人聊天 ID
1. 在 Telegram 中搜尋並開始與您的 Bot 對話
2. 發送任意訊息給 Bot（例如：`/start` 或 `hello`）
3. 在瀏覽器中訪問以下網址（替換 YOUR_BOT_TOKEN）：
   ```
   https://api.telegram.org/botYOUR_BOT_TOKEN/getUpdates
   ```
4. 在返回的 JSON 資料中找到 `"chat":{"id":數字}` 
5. 這個數字就是您的聊天室 ID（個人聊天通常是正數）

#### 方法二：透過 @userinfobot 取得個人 ID
1. 在 Telegram 中搜尋 `@userinfobot`
2. 開始對話並發送 `/start`
3. Bot 會直接回覆您的用戶 ID

#### 方法三：取得群組聊天室 ID
1. 將您的 Bot 加入目標群組
2. 在群組中發送任意訊息
3. 使用方法一的 API 網址查看 getUpdates
4. 群組 ID 通常是負數（例如：-1001234567890）

#### 方法四：透過 @RawDataBot 取得群組 ID
1. 將 `@RawDataBot` 加入您的群組
2. 在群組中發送任意訊息
3. Bot 會回覆包含群組 ID 的詳細資訊

#### 實際範例
假設您的 Bot Token 是：`8232088184:AAG2piqVAVbiBdKENJ8tsUlm8I4Zz2OmTV4`

訪問：
```
https://api.telegram.org/bot8232088184:AAG2piqVAVbiBdKENJ8tsUlm8I4Zz2OmTV4/getUpdates
```

返回的 JSON 範例：
```json
{
  "ok": true,
  "result": [
    {
      "update_id": 123456789,
      "message": {
        "message_id": 1,
        "from": {...},
        "chat": {
          "id": 987654321,
          "first_name": "Your Name",
          "type": "private"
        },
        "text": "hello"
      }
    }
  ]
}
```

在這個例子中，聊天室 ID 就是：`987654321`

## 5. 技術實作細節

### 5.1 影像識別
- **螢幕截圖**: 即時擷取指定區域畫面
- **顏色檢測**: 計算指定顏色在區域內的像素數量
- **畫面變化檢測**: 比較前後畫面差異判斷是否有變化

### 5.2 自動化控制
- **滑鼠點擊**: 在指定座標執行點擊動作
- **熱鍵監聽**: 監聽 F1 按鍵用於位置記錄
- **定時器**: 控制各階段的執行時間和間隔

### 5.3 錄製技術實作
- **螢幕截圖**: 使用 mss 高效截取指定區域畫面
- **影像比較**: 使用 OpenCV 計算畫面變化程度
- **滑鼠監聽**: 使用 pynput 全域監聽滑鼠點擊事件
- **多執行緒**: 錄製循環與 GUI 介面分離，避免阻塞
- **變化閾值**: 可調整的畫面變化敏感度（預設 15%）
- **區域智能切換**: 根據當前階段自動選擇檢測區域

### 5.3 錯誤處理
- **網路錯誤**: Telegram API 呼叫失敗的重試機制
- **畫面識別失敗**: 提供手動介入或重新開始選項
- **系統異常**: 記錄錯誤日誌並提供除錯資訊

## 6. 程式安裝與執行

### 6.1 系統需求
- **作業系統**: Windows 10/11
- **Python 版本**: Python 3.8 或以上
- **必要套件**: 見 requirements.txt

### 6.2 安裝步驟

#### 方法一：使用 Python 直接執行（推薦）
```bash
# 1. 安裝依賴套件
py -m pip install -r requirements.txt

# 2. 執行程式
py game_monitor.py
```

#### 方法二：使用 Python 虛擬環境（進階）
```bash
# 1. 建立虛擬環境
py -m venv venv

# 2. 啟動虛擬環境
venv\Scripts\activate

# 3. 安裝依賴套件
pip install -r requirements.txt

# 4. 執行程式
python game_monitor.py

# 5. 結束後關閉虛擬環境
deactivate
```

#### 方法三：批次檔啟動（推薦）
提供三種批次檔啟動方式：

**1. run.bat - 標準啟動（推薦新手）**
- 雙擊執行，顯示安裝進度
- 程式啟動後可關閉命令提示字元視窗
- 首次執行自動安裝套件

**2. run_silent.bat - 靜默啟動**
- 完全無視窗啟動
- 適合熟悉的使用者
- 程式在背景運行

**3. run_with_check.vbs - 智能啟動**
- 檢查程式是否已在運行
- 防止重複啟動
- 啟動狀態提示對話框

選擇任一方式雙擊即可執行

### 6.3 套件說明
程式依賴的主要套件：
- **pillow**: 圖像處理
- **pyautogui**: 螢幕截圖和滑鼠控制
- **requests**: HTTP 請求 (Telegram API)
- **opencv-python**: 影像識別和比較
- **keyboard**: 熱鍵監聽 (F1)
- **mss**: 高效能螢幕截圖
- **pynput**: 滑鼠點擊監聽（錄製功能）

## 7. 用戶操作流程

### 7.1 初始設定流程
1. 啟動程式
2. 設定 Telegram 聊天室 ID
3. 選擇王怪檢測區域（區域 1）
4. 選擇頻道切換檢測區域（區域 2）
5. 設定檢測顏色和閾值
6. 設定各階段點擊位置（使用 F1 熱鍵）
7. 設定時間參數
8. 測試 Telegram 通知功能
9. 開始監控

### 7.2 智能錄製流程（推薦新手使用）

#### 準備階段
1. 啟動程式
2. 點擊「開始錄製」按鈕
3. 系統檢查檢測區域設定
   - 未設定時自動引導設定王怪檢測區域和頻道檢測區域
   - 已設定時直接進入錄製模式
4. 確認開始錄製對話框

#### 錄製階段
1. **階段 A-B**: 系統監控王怪檢測區域，等待畫面變化
2. **階段 C**: 偵測到變化時彈出確認對話框，確認後點擊登入按鈕
3. **階段 D**: 繼續監控王怪檢測區域，確認後點擊角色選擇
4. **階段 E**: 監控王怪檢測區域，確認進入遊戲內畫面
5. **階段 F**: 切換到監控頻道檢測區域，依序點擊頻道切換操作

#### 完成階段
1. 系統自動分析記錄的點擊數據
2. 自動設定所有點擊位置參數
3. 自動儲存設定檔案
4. 顯示錄製結果報告
5. 錄製完成，可立即使用自動監控功能

#### 錄製技巧
- **畫面變化確認**: 當系統偵測到區域變化時，會顯示當前截圖供確認
- **點擊記錄**: 所有滑鼠左鍵點擊都會被記錄，包含位置和時間
- **階段管理**: 每個點擊會根據當前階段自動分類
- **錯誤處理**: 可隨時停止錄製重新開始

### 7.3 手動設定流程（進階使用者）
1. 啟動程式（自動載入已保存設定）
2. 設定 Telegram 聊天室 ID
3. 選擇王怪檢測區域（拖曳選擇）
4. 選擇頻道切換檢測區域（拖曳選擇）
5. 設定檢測顏色和閾值
6. 設定各階段點擊位置（使用 F1 熱鍵）
7. 設定時間參數
8. 測試 Telegram 通知功能
9. 開始監控

### 7.4 日常使用流程
1. 啟動程式（自動載入已保存設定）
2. 確認設定正確
3. 點擊「開始」按鈕啟動監控
4. 程式自動執行各階段流程
5. **系統控制選項**:
   - **隨時暫停**: 點擊「暫停」按鈕可隨時暫停當前工作
   - **從暫停恢復**: 點擊「繼續」按鈕恢復到暫停前的狀態
   - **完全停止**: 點擊「停止」按鈕完全終止程式，需重新點擊「開始」
6. **王怪處理流程**:
   - 收到 Telegram 通知（系統自動暫停，按鈕變為突出的「繼續」）
   - 前往遊戲打王怪
   - 打完王後點擊「繼續」按鈕
   - 系統自動執行階段 F（切換頻道）
   - 回到階段 E 繼續監控下一輪

## 8. 疑難排解

### 8.1 常見問題
- **程式無法啟動**: 檢查 Python 是否正確安裝，使用 `py --version` 確認
- **套件安裝失敗**: 確保網路連線正常，或使用 `py -m pip install --upgrade pip` 更新 pip
- **熱鍵無法使用**: 請以系統管理員身分執行程式
- **Telegram 通知失敗**: 檢查聊天室 ID 和網路連線

### 8.2 效能最佳化
- **關閉不必要的背景程式**: 減少 CPU 和記憶體使用
- **降低螢幕解析度**: 可提升影像處理速度
- **調整檢測間隔**: 根據系統效能調整偵測頻率

## 9. 待確認事項

### 9.1 技術選擇
- GUI 框架選擇：tkinter vs PyQt vs 其他
- 影像處理庫選擇：OpenCV vs PIL
- 是否需要多執行緒處理
- 錄製功能的滑鼠監聽技術選擇

### 9.2 功能細節
- 各階段間的轉換條件是否需要更精確的定義？
- 是否需要添加日誌記錄功能？
- 錯誤處理的具體策略？
- 錄製功能的變化敏感度是否需要可調整？
- 是否需要支援錄製暫停和恢復功能？

### 9.3 用戶體驗
- 介面布局和操作流程是否符合預期？
- 是否需要添加進度指示或狀態顯示？
- 錄製功能是否足夠直觀易用？
- 確認對話框的截圖大小和清晰度是否合適？
- 是否需要添加錄製教學或幫助功能？

---

請確認以上規格是否符合您的需求，有任何需要修改或補充的地方請告知。